<!DOCTYPE html>
<head>
	<% include ./templates/head.ejs %>
	<style>
		<% include ./style/workpage.css %>
	</style>
	<% if(login && isJoined) { %>
		<link rel="stylesheet" href="//cdn.jsdelivr.net/editor/0.1.0/editor.css">
	    <script src="/js/editor.js"></script>
	    <script src="/js/marked.js"></script>
	    <script>
			function editMD(id) {
				$('#editBio').attr({
						id: 'saveBio',
						onClick: 'saveBio()'
				}).text('저장하자');
				$('#bio').html('<div class="editor-wrapper"><textarea id="bioTextarea" class="editor" name="bio" rows="8" cols="40"></textarea></div>');
				bioEditor = new Editor({
					element: document.getElementById('bioTextarea')
				});
				bioEditor.render();
				bioEditor.codemirror.setValue($('#originMD').text().trim());
				$("html, body").animate({scrollTop: $(document).height()});
			}
	        function saveBio() {
	            $.ajax({
	                type: "POST",
	                url: '/user/<%=user.name%>',
	                xhrFields: {
	                       withCredentials: true
	                },
	                data: {
	                    bio: bioEditor.codemirror.getValue()
	                },
	                success: function(data, status) {
	                    console.log(data);
	                    switch(data) {
	                        case '200': {
	                            location.reload();
	                            break;
	                        }
	                        case '400': {
	                            //미구현
	                             break;
	                        }
	                        case '500': {
								alert('서버에 문제가 있다. 담당자를 때려죽이고 고쳐서 커밋하자.');
	                            //임시구현
	                        }
	                    }
	                }
	            });
	        }
	    </script>
		<% if(work.frontboard) { %>
			<div id='originReadme' class='originCon'>
				<%- include('../../public/workpage/'+work.name+'/front.md') %>
			</div>
		<% } %>
		<% if(work.needs) { %>
			<div id='originNeeds' class='originCon'>
				<%- include('../../public/workpage/'+work.name+'/needs.md') %>
			</div>
		<% } %>
	<% } %>
</head>
<body>
	<header>
        <% include ./templates/header.ejs %>
    </header>
	<div class="contentBox maxWrapper">
        <div class="content">
			<article>
				<div id="workhead">
					<h1><%= work.name %></h1>
					<span id="buttons">
						<button class="dislike" id="<%=work.id%>" dislikes=<%=numDislikes%>>싫어요 <span class='hh'><%= numDislikes %></span></button>
						<button class="joins" id="<%=work.id%>">참여</button>
					</span>
					<h2><%= work.desc %></h2>
				</div>
				<section id='readmeSec' class='md'>
					<div class='sectionTitle'>
						<h3>README.md</h3>
						<% if(login && isJoined) { %>
							<% if(!object.bio) { %>
								<button id='editMD' onClick='editBio("#readme")'>쓰자</button>
							<% } else { %>
								<button id='editMD' onClick='editBio("#readme")'>고치자</button>
							<% } %>
						<% } %>
					</div>
					<div id='readme'>
						<%- include('../../public/workpage/'+work.name+'/front.html') %>
					</div>
				</section>
				<section id='membersSec' class='half md'>
					<h3>참여하는 무리</h3>
					<div id='members'>
						<% for(var i = 0; i < members.length; i++) { %>
							<a href="/user/<%=members[i].nickname%>" class='memField'>
								<img class='memPic' src="<%=members[i].picture%>">
								<div class='memNick'><%=members[i].nickname%></div>
							</a>
						<% } %>
					</div>
				</section>
				<section id='needsSec' class='half md'>
					<div class='sectionTitle'>
						<h3>이런 사람 와라</h3>
						<% if(login && isJoined) { %>
							<% if(!object.bio) { %>
								<button id='editMD' onClick='editBio("#needs")'>쓰자</button>
							<% } else { %>
								<button id='editMD' onClick='editBio("#needs")'>고치자</button>
							<% } %>
						<% } %>
					</div>
					<div id='needs'>
						<%- include('../../public/workpage/'+work.name+'/needs.html') %>
					</div>
				</section>
				<section>
					<h3>로그</h3>
					<!--여기에 소켓으로 로그 긁어와서 보여주기-->
					<input type="text" id="logText">
					<input type="button" class="emitLog" value="똥싸기">
				</section>
			</article>
		</div>
	</div>
	<footer>
        <% include ./templates/footer.ejs %>
    </footer>
	<script>
		var socket = io.connect('http://<%=host%><%=port%>');
		var disliked = false;
		
		socket.on('news', function () {
			socket.emit('clientGetLogs',{
				workId: <%=work.id%>
			});	// 로그를 
			
			$('.dislike').click(function(){
				console.log("dislike emitted");
				var id = $(this).attr('id');
				socket.emit('clientUpdateDislike', {
					workId: <%=work.id%>,
					<% if(user) { %>
					userId: <%=user.id%>
					<% } else { %>
					user: null
					<% } %>
				});
			});
			$('.joins').click(function(){
				console.log("joins emitted");
				var id = $(this).attr('id');
				socket.emit('clientUpdateJoin',{
					workId: <%=work.id%>,
					<% if(user) { %>
					userId: <%=user.id%>
					<% } else { %>
					user: null
					<% } %>
				});
			});
			$('.emitLog').click(function(){
				console.log("emitLog emitted");
				var log = $('#logText').val();
				socket.emit('clientPostLog',{
					text: log,
					workName: "<%=work.name%>",
					<% if(user) { %>
					userId: <%=user.id%>
					<% } else { %>
					user: null
					<% } %>
				});
				socket.emit('clientGetLogs',{
					workId: <%=work.id%>
				});
			});
			socket.on('serverGetLogs', function (data) {
	            console.log(data);
	        });
		});
	</script>
</body>
</html>